blueprint:
  name: State aware scene toggle
  description: >
    Toggle scenes (e.g., LED on/off) for devices that can also be controlled physically.

    **Logic:**
    - This script maintains its own state using an `input_boolean` helper.
    - By default, it assumes the light is ON and will turn it OFF.
    - Stores the timestamp of the last OFF action in an input_text helper kept vaild for x hours.

    **Required setup:** 
    You must first create an input_boolean (state helper) and an input_text (last off timestamp) helper.

  domain: script
  input:
    scene_on:
      name: "On Scene"
      selector:
        entity:
          domain: scene
    scene_off:
      name: "Off Scene"
      selector:
        entity:
          domain: scene
    state_helper:
      name: "State Helper"
      description: "Input boolean used to store the perceived state (optional but recommended)."
      selector:
        entity:
          domain: input_boolean
    last_off_helper:
      name: "Last Off Timestamp"
      description: "An input_text helper used to store the ISO timestamp when the OFF scene was last triggered."
      selector:
        entity:
          domain: input_text
    timeout_hours:
      name: "Recent Action Timeout"
      default: 6
      selector:
        number:
          min: 0.5
          max: 24
          step: 0.5
          unit_of_measurement: hours
    transition_time:
      name: Transition Time
      description: The time in seconds for transitioning between scenes.
      default: 1
      selector:
        number:
          min: 0
          max: 10
          step: 0.5
          unit_of_measurement: seconds

mode: single

variables:
  scene_on_id: !input 'scene_on'
  scene_off_id: !input 'scene_off'
  state_helper_id: !input 'state_helper'
  last_off_helper_id: !input 'last_off_helper'
  timeout_hours_input: !input 'timeout_hours'
  timeout_seconds: "{{ timeout_hours_input | float * 3600 }}"

sequence:
  # If we have a recorded last-off timestamp and it is within the timeout window,
  - choose:
      - conditions:
          - condition: template
            value_template: >-
              {% set ts = states[last_off_helper_id].state %}
              {{ ts != None and ts != '' and (as_timestamp(now()) - as_timestamp(ts) < timeout_seconds) }}
        sequence:
          - service: scene.turn_on
            target:
              entity_id: !input 'scene_on'
            data:
              transition: !input 'transition_time'
          - service: input_boolean.turn_on
            target:
              entity_id: !input 'state_helper'
          - service: input_text.set_value
            target:
              entity_id: !input 'last_off_helper'
            data:
              value: ""
    default:
      # Default: assume device is ON, so turn it OFF and record the time.
      - service: scene.turn_on
        target:
          entity_id: !input 'scene_off'
      - service: input_boolean.turn_off
        target:
          entity_id: !input 'state_helper'
      - service: input_text.set_value
        target:
          entity_id: !input 'last_off_helper'
        data:
          value: "{{ now().isoformat() }}"
